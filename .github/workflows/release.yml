name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  QT_VERSION: '6.5.3'

jobs:
  # Windowsæž„å»ºä»»åŠ¡
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    continue-on-error: true
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        
    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        
    - name: Deploy Qt
      run: |
        cd build
        if (Test-Path "Release\ImageBackgroundExpander.exe") {
          cd Release
          windeployqt --release ImageBackgroundExpander.exe
        } else {
          windeployqt --release ImageBackgroundExpander.exe  
        }
        
    - name: Package Windows
      run: |
        # Get version from tag
        $VERSION = "${{ github.ref_name }}"
        if ($VERSION -like "v*") {
          $VERSION = $VERSION.Substring(1)
        }
        
        $PACKAGE = "ImageBackgroundExpander-$VERSION-Windows-x64"
        New-Item -ItemType Directory $PACKAGE -Force
        
        cd build
        if (Test-Path "Release") {
          Copy-Item "Release\*" "..\$PACKAGE\" -Recurse -Force
        } else {
          Get-ChildItem . -Exclude "CMakeFiles","*.cmake","CMakeCache.txt","*.vcxproj*","*.sln" | Copy-Item -Destination "..\$PACKAGE\" -Recurse -Force
        }
        
        cd ..
        Copy-Item "README.md" "$PACKAGE\" -ErrorAction SilentlyContinue
        
        Compress-Archive $PACKAGE "$PACKAGE.zip"
        Write-Host "Created: $PACKAGE.zip"
        
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: "ImageBackgroundExpander-*.zip"
        retention-days: 7

  # åˆ›å»ºReleaseä»»åŠ¡
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: always() && needs.build-windows.result == 'success'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -name "*.zip" | while read file; do
          echo "Found asset: $file"
          cp "$file" release-assets/
        done
        
        ls -la release-assets/
        
    - name: Generate release notes
      run: |
        # Get version from tag
        VERSION="${{ github.ref_name }}"
        if [[ $VERSION == v* ]]; then
          VERSION=${VERSION#v}
        fi
        
        # Create release notes using echo
        echo "# ImageBackgroundExpander $VERSION" > release-notes.md
        echo "" >> release-notes.md
        echo "## ðŸ“¦ å¯ç”¨å¹³å°" >> release-notes.md
        
        # Check which platforms are available
        if find artifacts/windows-build -name "*.zip" 2>/dev/null | grep -q .; then
          echo "- âœ… **Windows** - ä¾¿æºç‰ˆZIPåŒ…" >> release-notes.md
        else
          echo "- âŒ **Windows** - æž„å»ºå¤±è´¥" >> release-notes.md
        fi
        
        # Add usage instructions
        echo "" >> release-notes.md
        echo "## ðŸš€ å¦‚ä½•ä½¿ç”¨" >> release-notes.md
        echo "" >> release-notes.md
        echo "1. æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…" >> release-notes.md
        echo "2. Windows: è§£åŽ‹ZIPæ–‡ä»¶ï¼Œè¿è¡ŒImageBackgroundExpander.exe" >> release-notes.md
        echo "" >> release-notes.md
        echo "## âœ¨ æ–°åŠŸèƒ½" >> release-notes.md
        echo "" >> release-notes.md
        echo "- ðŸŽ¯ å›¾ç‰‡é€‰æ‹©æ—¶è‡ªåŠ¨è·³è½¬åˆ°ä¸Šæ¬¡é€‰æ‹©çš„è·¯å¾„" >> release-notes.md
        echo "- ðŸ”§ çŽ°ä»£åŒ–æž„å»ºç³»ç»Ÿï¼ˆCMake + Qt6ï¼‰" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ðŸ“ æ›´æ–°å†…å®¹" >> release-notes.md
        echo "" >> release-notes.md
        echo "è¯¦è§æäº¤è®°å½•ä¸­çš„æ›´æ”¹ã€‚" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ðŸ› é—®é¢˜åé¦ˆ" >> release-notes.md
        echo "" >> release-notes.md
        echo "å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆã€‚" >> release-notes.md
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: ImageBackgroundExpander ${{ github.ref_name }}
        body_path: release-notes.md
        files: release-assets/*
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
